# 第一阶段（MVP）业务流程图

本项目第一阶段的目标是实现“领域 Copilot”，验证端到端 Text-to-Data 的可行性。以下是核心业务流程的图解。

## 1. 用户登录与场景导航流程

描述从用户访问系统、身份验证到进入特定业务场景（如“销售域”）的过程。

```mermaid
sequenceDiagram
    actor User as 业务人员
    participant Frontend as 前端 (Next.js)
    participant Backend as 后端 (FastAPI)
    participant Auth as 统一身份认证 (SSO/Local)
    participant DB as 应用数据库 (PostgreSQL)

    User->>Frontend: 访问灵犀问数 URL
    Frontend->>Frontend: 检查本地 Token (JWT)
    alt 无效或不存在
        Frontend->>User: 展示登录页面
        User->>Frontend: 输入用户名/密码 (或 SSO 点击)
        Frontend->>Backend: 登录请求 (Login Action)
        Backend->>Auth: 转发验证请求
        Auth-->>Backend: 返回用户信息 & 凭证
        Backend->>DB: 记录登录日志/同步用户信息
        Backend-->>Frontend: 返回 JWT Token
    end

    Frontend->>Backend: 获取当前用户可访问的场景列表
    Backend->>DB: 查询用户角色关联的场景知识库
    DB-->>Backend: 返回场景元数据 (销售域, 财务域等)
    Backend-->>Frontend: 返回场景列表
    Frontend->>User: 展示 Landing Page (场景导航)
    User->>Frontend: 点击选择“销售域”
    Frontend->>Frontend: 跳转至 /chat/:scene_id
```

---

## 2. 端到端智能问数 (Text-to-Data) 流程

这是最核心的业务闭环，展示了如何从自然语言产生业务数据结论。

```mermaid
sequenceDiagram
    actor User as 业务人员
    participant UI as 聊天界面 (ChatInterface)
    participant AG as 智能 Agent 网关 (FastAPI)
    participant WE as Wren Engine (WrenAI)
    participant LLM as 私有化大模型 (Qwen/DeepSeek)
    participant Data as 数据平台/数仓 (Trino/PG)

    User->>UI: 输入问题: "上个月华东区销售额是多少?"
    UI->>AG: 发送消息请求 (Streaming)
    
    rect rgb(240, 248, 255)
    Note over AG, LLM: 意图识别与语义增强 (Core Interaction)
    AG->>LLM: 识别用户意图 (数据查询/归因/闲聊)
    LLM-->>AG: 意图: 数据查询
    AG->>WE: Schema Linking (识别相关表与字段)
    WE-->>AG: 确认对应 MDL 模型: "销售域-交易明细"
    end

    rect rgb(255, 250, 240)
    Note over AG, LLM: SQL 生成与安全拦截
    AG->>WE: 请求生成 SQL (Context: Prompt + MDL)
    WE->>LLM: Text2SQL 推理
    LLM-->>WE: 返回生成的 SQL 代码
    WE-->>AG: 返回生成的 SQL
    AG->>AG: 注入行级权限 (RLS Check: dept='华东区')
    AG->>AG: SQL 安全性校验 (AST 静态检查)
    end

    rect rgb(240, 255, 240)
    Note over AG, Data: 数据执行与反馈
    AG->>Data: 执行 SQL
    Data-->>AG: 返回 JSON 结果集 (Result Set)
    AG->>LLM: 根据结果集推荐图表类型 & 生成数据总结
    LLM-->>AG: 文字总结 + 图表配置 (ECharts Config)
    end

    AG-->>UI: 推送 SSE 流式响应 (思维链 -> SQL -> 表格 -> 图表)
    UI->>User: 呈现高度可视化的问数结果
```

---

## 3. 管理端：元数据初始化与建模流程

描述管理员在第一阶段如何快速搭建一个业务域问数服务。

```mermaid
graph TD
    A[管理员] -->|1. 下载模板| B(元数据 Excel 模板)
    B -->|2. 填写资产信息| B1[物理表名/备注/业务名称/指标定义]
    B1 -->|3. 上传导入| C{后台校验器}
    C -->|不通过| C1[提示格式错误]
    C -->|通过| D[Metadata Syncer]
    
    D -->|4. 生成 MDL| E[Wren Engine 语义层]
    E -->|5. 可视化配置| F[实体关系配置 ERD]
    E -->|6. SQL Pair 提供| G[Few-shot 黄金问答对管理]
    
    G -->|7. 发布场景| H[业务人员可见]
```

---

## 流程说明

1.  **关于权限**：流程图 2 中体现了“语义级 RLS”，即后端在生成的 SQL 执行前，会根据用户身份动态追加过滤条件，确保数据的隔离性。
2.  **关于流式渲染**：前端采用 SSE 协议，使得“思考过程”和“最终结论”能够分步呈现出来，极大减少了用户等待的焦虑感。
3.  **关于建模**：第一阶段主要依靠手动维护的 Excel 模板进行元数据注入，后期将通过 API 对接数据治理平台实现自动化。

---

## 4. 智能 Agent 任务规划流程 (Agent Planning)

展示 Agent 如何将用户模糊的自然语言指令拆解为可执行的任务链。

```mermaid
graph TD
    User((用户)) -->|输入指令| Controller[Agent 控制器]
    Controller -->|1. 意图分类| Intent{意图识别}
    
    Intent -->|数据查询| TaskGroup[数据任务组]
    Intent -->|归因分析| ReasoningGroup[推理任务组]
    
    subgraph "任务规划与拆解"
    TaskGroup --> Step1[1. 识别 Schema 范围]
    Step1 --> Step2[2. 检索 Few-Shot 问答对]
    Step2 --> Step3[3. 加载 MDL 语义模型]
    Step3 --> Step4[4. 生成初步 SQL]
    end
    
    subgraph "思维链生成"
    Step4 --> CoT[生成 <think> 标签内容]
    CoT --> PlanView[前端展示规划步骤]
    end
    
    PlanView --> Execute[进入执行阶段]
```

---

## 5. SQL 自愈与错误修正流程 (Self-Correction)

描述当 SQL 执行失败或结果不符合预期时，系统的自动反思与修正机制。

```mermaid
sequenceDiagram
    participant AG as Agent Gateway
    participant WE as Wren Engine
    participant LLM as LLM (Reflector)
    participant Data as Database

    AG->>WE: 请求执行 SQL
    WE->>Data: 运行 SQL
    alt 执行报错 (Syntax Error)
        Data-->>WE: 返回错误信息 (如: Column not found)
        WE->>LLM: 提供 [原始 SQL] + [错误信息] + [MDL 上下文]
        Note over LLM: LLM 进行自我反思 (Self-Reflection)
        LLM-->>WE: 返回修正后的 SQL
        WE->>Data: 重新执行修正后的 SQL
    else 结果为空 (Unexpected Empty)
        Data-->>WE: 返回 Empty Set
        WE->>LLM: 用户问的是 X, 结果为空, 是否逻辑有误?
        LLM-->>WE: 调整过滤条件或重新关联拓扑
        WE->>Data: 再次尝试
    end
    Data-->>AG: 返回最终正确结果
```

---

## 6. 用户反馈与治理信号回流流程 (Governance Loop)

体现“以用促管”的闭环，将前端应用的使用信号反哺至后端模型与治理端。

```mermaid
flowchart LR
    subgraph "用户交互层"
    A[用户] -->|点赞/点踩| B[反馈收集组件]
    A -->|手动修正 SQL| C[SQL 编辑器]
    end

    subgraph "后端逻辑层"
    B --> D[反馈存储服务]
    C --> E[修正记录捕获]
    end

    subgraph "数据治理反哺"
    D --> F{信号分类}
    E --> F
    F -->|模型优化| G[Few-Shot 语料库库更新]
    F -->|元数据缺陷| H[治理平台告警 / 待办任务]
    F -->|口径冲突| I[业务词典校准]
    end

    G -.->|下一次查询更准| A
    I -.->|指标定义完善| A
```

---

## 7. 场景权限管理与授权流程 (Permissions)

描述管理员如何对用户、角色和场景知识库进行关联授权。

```mermaid
sequenceDiagram
    actor Admin as 管理员
    participant Portal as 管理后台 (Shell)
    participant Auth as RBAC 服务
    participant DB as 应用数据库

    Admin->>Portal: 进入“用户授权”模块
    Portal->>DB: 查询现有“场景知识库”列表
    DB-->>Portal: 返回 (销售域, 财务域, HR域)
    Admin->>Portal: 选择用户 A, 绑定“销售域”场景
    Portal->>Auth: 校验权限分发策略
    Auth->>DB: 写入 User-Scene 关联表
    DB-->>Portal: 授权成功
    
    Note over Admin, DB: 用户 A 下次登录时，Landing Page 仅显示“销售域”
```
