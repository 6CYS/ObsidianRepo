## 1. 产品概述 (Product Overview)

### 1.1 产品简介
**灵犀问数** 是一款连接企业数据治理资产与大语言模型（LLM）的智能问数（Text-to-Data）平台。它旨在通过自然语言交互，帮助业务人员直接获取数据洞察，实现从“人找数据”到“数据找人”的范式转变。

### 1.2 产品定位
- **定位**：企业级智能问数中间件与分析 Agent。
- **核心逻辑**：左侧对接数据治理及资产平台（元数据来源），中间通过灵犀问数引擎进行语义转换与推理，右侧支撑各类智能体与分析报告。
- **价值主张**：
    - **查得准**：利用“治理即语义”消除大模型幻觉。
    - **可视快**：自动生成 SQL 并推荐合适的图表展示。
    - **资产活**：将静态的数据治理成果转化为动态的 AI 上下文。

![](assets/恩核智能问数产品「灵犀问数」产品方案/file-20251212115002406.png)

---

## 2. 核心竞争力与差异化 (Key Differentiators)

针对市面上通用 Text-to-SQL 产品的准确性低、权限管控难、应用与治理脱节等痛点，灵犀问数构建了独特的**“管用一体”**生态优势：

1.  **治理即语义：以管奠基用 (Governance as Semantics)**
    - **原理**：不直接读取物理数据库 Schema，而是通过**元数据注入管道 (Metadata Injection Pipeline)**，将经过治理的标准指标、口径定义自动转化为语义模型（MDL）。
    - **价值**：将静态的数据标准转化为动态的 AI 上下文，结合 **RAG** 技术，从源头消解大模型对业务术语理解的二义性，确保“查得准”。

2.  **用管共生：以用反哺管 (Usage-Driven Governance Synergy)**
    - **理念**：超越单向利用，构建**“以管赋能用，以用促管”**的双向飞轮，实现数据资产的自进化。
    - **机制**：
        - **价值量化**：通过分析用户的自然语言提问热度，自动生成数据资产的“热力图”，帮助治理团队将资源精准投放到高频核心资产上。
        - **众筹式治理**：将用户的每一次 SQL 修正、点赞/踩、口径疑问（如“含不含税？”）转化为高价值的**“治理信号”**实时回流至资产平台。让业务一线成为治理的参与者，驱动指标口径的持续校准与完善。

3.  **企业级安全管控：全域护航 (Enterprise-Grade Security)**
    - **语义级 RLS**：在语义层而非仅数据库层实施权限控制。根据用户 Token 动态注入过滤条件，确保 AI 生成的 SQL 永远不会突破用户的权限范围。
    - **数据不出域**：支持 vLLM + 开源模型（如 Qwen 2.5-Coder）的完全私有化运行，构建物理隔离的安全围栏。

---

## 3. 技术架构设计 (Technical Architecture)

本项目采用 **前后端分离 (Decoupled)** 与 **Headless BI** 的架构模式，确保灵活性与可扩展性。

### 3.1 总体架构图谱

系统划分为四层：

| 架构层级 | 核心组件 | 技术选型 | 核心职责 |
| :--- | :--- | :--- | :--- |
| **交互层 (Frontend)** | 智能问答 Console, 嵌入式 SDK | **Next.js 14+**, **Shadcn/UI**, ECharts | 用户意图捕获、流式渲染、可视化展示 |
| **编排层 (Service)** | API网关, 任务路由, 上下文管理 | **FastAPI (Python)**, **LiteLLM** | 鉴权、限流、模型统一适配、任务分发 |
| **语义智能层 (Core)** | 语义建模引擎(MDL), 向量服务 | **Wren Engine**, **Vanna**, Qdrant | 元数据转语义模型、RAG 检索、SQL 生成 |
| **基础设施层 (Infra)** | 私有模型推理, 数据仓储 | **vLLM**, PostgreSQL, Trino | 算力供给(Qwen/DeepSeek)、数据存储 |

### 3.2 技术栈选型 (Technology Stack)

#### 前端 (Frontend)
- **框架**: **Next.js 14+ (App Router)** - 支持 SSR/CSR 及优秀的流式数据支持。
- **语言**: **TypeScript** - 保证类型安全。
- **UI 组件**: **Shadcn/UI + Tailwind CSS** - 现代化、轻量级、符合 ChatGPT 风格的交互体验。
- **Markdown/代码渲染**: `react-markdown` (支持 LaTeX, Mermaid), `react-syntax-highlighter`。
- **状态管理**: Zustand.

#### 后端 (Backend)
- **核心框架**: **Python 3.10+**, **FastAPI** - 高性能异步框架，原生支持 SSE 流式响应。
- **模型网关**: **LiteLLM** - 统一管理 OpenAI, DeepSeek, Claude 等模型调用，实现“模型防腐层”。
- **语义引擎**: 
    - **WrenAI Core**: 负责语义建模（MDL）与精准 SQL 生成。
    - **Vanna.ai**: 负责非结构化文档、业务口径描述的 RAG 检索。
- **数据验证**: Pydantic.
- **ORM**: SQLAlchemy / Prisma.

#### 这里的关键设计：
后端通过 **FastAPI** 封装核心业务逻辑，下层调用 **LiteLLM** 统一大模型接口，同时集成 **Wren Engine** 处理结构化查询，集成 **Vanna** 处理非结构化辅助信息。

---

## 4. 核心功能组件与流程 (Key Features & Data Flow)

### 4.1 前端交互组件
1.  **`ChatInterface`**: 
    - 主控组件，管理 `messages[]` 状态，处理 SSE 流式数据。
    - 实现“打字机”滚动效果。
2.  **`ThinkingBubble` (思维链可视化)**:
    - 专门解析推理模型（如 DeepSeek-R1）的 `<think>...</think>` 标签。
    - 默认折叠，点击展开，将 AI 的“思考过程”与“最终结论”视觉分离。
3.  **`MessageRenderer`**:
    - 区分 User/Assistant 样式。
    - 支持 Markdown 表格、ECharts 图表动态渲染。

### 4.2 核心数据流：流式对话与查询
1.  **用户提问**：用户输入“上个月华东区销售额为何下降？”。
2.  **意图识别 & 路由**：后端判断意图（数据查询 vs 归因分析）。
3.  **Schema Linking (Schema 链接)**：
    - 利用元数据中的“数据域”标签，仅加载相关域（如“销售域”）的 MDL 模型。
    - Vanna 检索相关的业务口径说明（如“销售额不含退款”）。
4.  **SQL 生成**：
    - Inject 元数据 + 检索到的口径 + 用户问题 -> Prompt。
    - LLM 生成 SQL。
5.  **安全校验 & 执行**：
    - 解析 Token，注入 RLS 过滤条件（如 `WHERE dept_id = '1001'`）。
    - 语法树（AST）校验 SQL 安全性。
    - 数据库执行查询。
6.  **流式响应**：
    - 结果以 SSE (Server-Sent Events) 格式流式推送到前端。
    - 前端逐步渲染：“思考过程” -> “生成的 SQL” -> “数据表格/图表” -> “文字总结”。

---

## 5. 落地路线图 (Roadmap)

### 第一阶段：MVP —— 领域 Copilot (1-3个月)
- **目标**：单一业务领域（如销售）验证端到端可行性。
- **动作**：
    - 部署 WrenAI (Docker) + vLLM (Qwen 2.5-Coder-32B)。
    - 人工构建销售域“黄金标准” MDL 模型。
    - 开发基础 Chat 界面，集成 SSO。
- **交付**：内部可用的销售数据助手，SQL 准确率 > 80%。

### 第二阶段：产品化 —— 治理驱动的自动化平台 (4-8个月)
- **目标**：实现元数据自动化注入，发布标准化 SDK。
- **动作**：
    - 开发 **Metadata Syncer**：对接数据治理平台，自动生成 MDL。
    - 实现 **语义级 RLS** 权限控制。
    - 封装 `<SmartQueryChat />` SDK，嵌入 CRM/ERP 系统。
- **交付**：灵犀问数平台 V1.0，支持多领域自动接入。

### 第三阶段：成熟期 —— 自主智能 Agent (9-12个月+)
- **目标**：从“被动查询”转向“主动分析”。
- **动作**：
    - 引入 **Self-Correction**：SQL 报错自动修正。
    - **主动洞察**：分析数据波动原因，进行异常预警。
    - **RLHF 微调**：利用积累的问答对微调私有模型，彻底掌握“企业方言”。
- **交付**：虚拟数据分析师 (Virtual Analyst)。

---

## 6. 未来应用场景 (Future Application Scenarios)

### 6.1 业务赋能型场景 (Business-Oriented)
专注于降低数据获取门槛，通过对话式交互提升业务决策效率，让数据在业务流程中即时流动。

1.  **经营决策驾驶舱 (Executive Copilot)**
    -   **场景描述**：企业高管与管理者无需打开复杂的固定报表，直接询问“本季度华东区利润率为何下滑？”，系统不仅以图表展示数据趋势，还能自动下钻维度，识别出是特定产品线或区域导致的问题。
    -   **价值**：将决策信息获取周期从“天”级缩短至“分钟”级，支持实时决策。

2.  **嵌入式业务助手 (Embedded Analytics)**
    -   **场景描述**：以 SDK/Widget 形式无缝嵌入 CRM、ERP 或 OA 系统。例如，销售人员在 CRM 查看客户详情时，可直接侧边栏提问“该客户过去三年的回款趋势如何？”，无需跳转至独立 BI 平台。
    -   **价值**：实现“数据找人”，在业务发生的场景中即时提供数据支撑。

3.  **智能归因与预警 (Automated Insight)**
    -   **场景描述**：当监测到关键指标异常（如销量今日突降 20%）时，系统主动触发分析 Agent，多维归因（价格变动、库存不足、竞品活动等），并主动推送简报给相关负责人。
    -   **价值**：从被动查数转向主动预警与智能诊断。

### 6.2 治理与资产融合型场景 (Governance & Asset Integration)
充分利用数据治理的成果反哺数据消费，同时通过问答交互促进治理闭环，让“沉睡”的资产活起来。

1.  **“所见即所问”的资产门户 (Ask the Asset)**
    -   **场景描述**：用户在数据资产平台浏览数据地图或目录时，找到感兴趣的资产（如“客户360宽表”），可直接点击“对它提问”按钮。系统自动加载该资产的最新元数据上下文，用户即可开始自由查询，无需理解底层表结构或 SQL。
    -   **价值**：打通数据资产发现到数据消费的“最后一公里”，极大提升资产复用率。

2.  **智能血缘与质量问答 (Meta-QA)**
    -   **场景描述**：用户不仅可以查询数据本身，还可以查询数据的“元信息”。例如提问：“这个‘净利润’指标的计算口径是什么？”、“这个数据来源是哪里？最近一次更新时间？”、“这张表的数据质量评分是多少？”。
    -   **价值**：建立用户对数据的信任度（Data Trust），让数据治理的隐性价值显性化，辅助用户判断数据可用性。

3.  **治理辅助与影响分析 (Governance Assistant)**
    -   **场景描述**：数据开发人员或治理专员可通过对话高效工作。例如：“如果我修改了‘订单表’的金额字段，会影响哪些下游报表和 API？”系统基于元数据图谱自动分析并返回影响范围。
    -   **价值**：通过自然语言交互降低专业治理工具的使用门槛，提升治理运维效率。
