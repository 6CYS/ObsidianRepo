# 智能问数（灵犀问数）产品需求说明书 (PRD)

| 文档版本 | 修改日期 | 修改人 | 修改内容 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| V1.0 | 2025-12-18 | Liuchen | 初始版本创建，基于产品方案草案整理 | Draft |

---

## 1. 引言 (Introduction)

### 1.1 背景与目的
随着企业数字化转型的深入，数据资产日益庞大，但“人找数据”的传统模式门槛高、效率低，难以满足敏捷决策的需求。大语言模型（LLM）的出现为Text-to-Data提供了可能，但通用模型存在幻觉严重、权限管控难、不懂企业术语等问题。
本项目旨在打造一款企业级智能问数产品——**灵犀问数**，连接数据治理资产与LLM，通过自然语言交互实现数据洞察的快速获取，推动从“人找数据”到“数据找人”的范式转变。

### 1.2 产品定位
*   **定位**：企业级智能问数 Agent，以数据治理平台为依托，为用户提供快速生成SQL、查询数据及生成报表的智能服务。
*   **核心逻辑**：左连数据治理平台（获取标准元数据等），中置灵犀问数引擎（语义转换与安全管控），右撑各类业务智能体与分析场景。
*   **核心理念**：“治理即语义” (Governance as Semantics) 与 “以用促管” (Usage-Driven Governance)。

### 1.3 适用人员
*   **企业高管/决策者**：通过问答快速获取经营KPI，辅助即时决策。
*   **业务人员 (销售/运营/财务等)**：无需SQL技能，自助查询业务数据，获取归因分析报告。
*   **数据分析师**：利用Copilot加速SQL编写与报表制作，提升效率。
*   （未来）**数据治理专员**：通过用户问答热度与反馈，优化元数据质量与指标口径。

---

## 2. 产品总体概述 (Product Overview)

### 2.1 核心价值主张
1.  **查得准**：利用“治理即语义”消除大模型幻觉，确保业务术语理解无误。
2.  **可视快**：自动生成 SQL 并推荐最佳可视化图表，缩短从提问到洞察的时间。
3.  **资产活**：将静态的治理成果（元数据、指标、口径）转化为动态的 AI 上下文，激活沉睡资产。

### 2.2 核心竞争力
1.  **治理即语义 (Governance as Semantics)**：不直接读库，而是通过 **Metadata Injection Pipeline** 读取治理后的元数据与标准指标，从源头消解二义性。
2.  **用管共生 (Usage-Driven Governance Synergy)**：构建双向飞轮，将用户提问热度、修正反馈、点赞/踩转化为治理信号，反哺元数据优化。
3.  **企业级安全管控 (Enterprise-Grade Security)**：实施 **语义级 RLS (Row Level Security)**，数据不出域，支持私有化部署。

### 2.3 总体架构
系统采用 **“管理壳 (Shell) + 核心引擎 (Core)”** 的双层架构设计：
*   **产品应用层 (The Shell)**：作为业务“壳子”，提供用户统一入口与场景管理能力。
    *   **管理后台**：用户/租户管理、场景知识库配置、数据源连接管理。使用 **PostgreSQL** 存储系统数据。
    *   **交互前端**：User Chat Interface, Next.js + Shadcn/UI, ECharts 可视化。
    *   **后端服务**：基于 **Python (FastAPI)** 构建高性能 API 网关与业务逻辑处理。
*   **语义智能层 (The Core)**：基于 **WrenAI 开源版** 进行封装，提供核心 Text-to-SQL 能力。
    *   **Wren Engine**: 核心语义与 SQL 生成引擎。
    *   **基础设施层 (Infra)**：vLLM 推理服务 (Qwen/DeepSeek), **PostgreSQL** (应用数据库), Trino (可选，数据仓库引擎)。

---

## 3. 功能需求说明 (Functional Requirements)

### 3.1 平台基础功能 (Platform Basic Features)
本模块提供产品的通用底座能力，面向所有登录用户。

| 功能点ID | 功能名称 | 需求描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| F-BASE-01 | **基础登录认证** | 提供独立的产品登录页面，支持用户名/密码登录、退出、密码修改等基础功能。 | P0 |
| F-BASE-02 | **登录后落地页 (Landing Page)** | 用户登录成功后的起始页面，展示用户可访问的“场景知识库”导航、个人概览及快速入口。 | P0 |

### 3.2 运营管理功能
本模块为后端管理能力，由具备管理员权限的用户进行操作，用于支撑业务运行。

| 功能点ID | 功能名称 | 需求描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| F-MGT-01 | **用户管理** | 1. 基础用户增删改查。 <br> 2. **支持 Excel 批量导入用户**。 | P0 |
| F-MGT-02 | **角色管理 (RBAC)** | 自定义角色，并配置相应的功能与数据范围权限。 | P0 |
| F-MGT-03 | **场景知识库管理** | 管理数据源连接、语义模型及场景隔离描述。 | P0 |
| F-MGT-04 | **用户与场景授权** | 将用户或角色关联至特定的“场景知识库”，确定其业务可见性。 | P0 |
| F-MGT-05 | **场景数据建模** | 基于场景知识库维度进行数据建模（集成 WrenAI 能力）。 | P0 |
| F-MGT-06 | **场景问答 SQL Pair 管理** | 基于场景知识库维度进行问答对配置与管理。**支持通过 Excel 批量导入问答对**（调用并适配 WrenAI 功能）。 | P0 |
| F-MGT-07 | 多租户管理 (进阶) | (预留) 支持多租户逻辑隔离及跨租户管理能力。 | P2 |

### 3.3 核心对话交互

| 功能点ID | 功能名称 | 需求描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| F-CHAT-01 | 自然语言提问 | 支持用户输入自然语言问题（如“上个月华东区销售额趋势”）。支持上下文多轮对话。 | P0 |
| F-CHAT-02 | 流式响应 (Streaming) | 采用打字机效果流式输出结果，降低用户等待焦虑。 | P0 |
| F-CHAT-03 | 思维链可视化 (Thinking Bubble) | 展示模型的推理过程（`<think>`标签内容），默认折叠，支持点击展开查看 AI 思考逻辑。 | P1 |
| F-CHAT-04 | 意图识别与路由 | 自动判断用户意图是“数据查询”、“归因分析”还是“闲聊”，并路由至对应处理流程。 | P0 |
| F-CHAT-05 | 追问与修正 | 支持用户基于上一轮结果进行追问或对生成的 SQL 进行自然语言修正。 | P1 |

### 3.4 数据查询与可视化

| 功能点ID | 功能名称 | 需求描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| F-DATA-01 | Text-to-SQL 生成 | 调用 WrenAI 核心引擎，基于语义模型 (MDL) 生成准确的可执行 SQL。 | P0 |
| F-DATA-02 | 自动图表推荐 | 根据数据结果类型（时序、分类、占比等）自动推荐并渲染最合适的 ECharts 图表（折线、柱状、饼图等）。 | P0 |
| F-DATA-03 | SQL 代码预览与解释 | 提供“SQL 预览”折叠面板，展示生成的 SQL 代码，并提供自然语言解释。 | P1 |
| F-DATA-04 | 表格展示与导出 | 支持以表格形式展示明细数据，并支持导出为 Excel/CSV。 | P1 |
| F-DATA-05 | 异常/空结果处理 | 当查询结果为空或 SQL 执行报错时，提供友好的提示与建议 (Self-Correction)。 | P1 |

### 3.5 语义模型与引擎对接
**注意**：本模块部分核心功能直接复用 **WrenAI 开源版** 的原生能力，不做二次开发，仅做 iframe 嵌入或接口集成。

| 功能点ID | 功能名称 | 需求描述 | 实现方式 | 优先级 |
| :--- | :--- | :--- | :--- | :--- |
| F-SEM-01 | 元数据自动注入 | 支持从数据治理平台定期同步元数据，自动更新下层 WrenAI 的 MDL 模型。 | 自研集成 | P1 |
| F-SEM-02 | Schema Linking | 提问时利用元数据标签进行 Schema 链接，仅召回相关场景的模型上下文。 | 自研集成 | P0 |
| F-SEM-04 | 模型热更新 | 支持在不重启服务的情况下热更新语义模型配置。 | 自研集成 | P2 |
| F-SEM-05 | **场景可视化数据建模** | 在各场景内部提供可视化的实体关系图 (ERD) 编辑、计算字段定义、表关联配置。 | **[引用 WrenAI]** | P0 |
| F-SEM-06 | **场景 SQL Pair 适配** | 提供问答对 (Q&A Pairs) 的配置入口，并适配至各场景的 LLM 推理上下文。 | **[引用 WrenAI]** | P1 |

### 3.6 安全与权限管控

| 功能点ID    | 功能名称     | 需求描述                                                                               | 优先级 |
| :------- | :------- | :--------------------------------------------------------------------------------- | :-- |
| F-SEC-01 | 用户统一鉴权   | 壳子层集成企业统一认证，向引擎层透传用户身份。                                                            | P0  |
| F-SEC-02 | 场景级访问控制  | **(替代 RLS)** 权限控制粒度设定为**“场景知识库”**级。用户只要拥有该场景的权限，即可查询场景下所有模型数据。细粒度 RLS 暂不作为 MVP 需求。 | P0  |
| F-SEC-03 | SQL 安全校验 | 通过 AST 解析校验生成的 SQL，禁止 DROP、DELETE 等高危操作。                                           | P0  |

### 3.7 治理反馈闭环 (Governance Feedback)
| 功能点ID | 功能名称 | 需求描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| F-GOV-01 | 查询评价 (Thumb Up/Down) | 用户可对查询结果点赞或点踩，并填写反馈理由。 | P2 |
| F-GOV-02 | 资产热力图 | 后台统计数据资产（表、指标）的被查询频次，生成热力图，指导治理重点。 | P2 |
| F-GOV-03 | 治理信号回流 | 将用户的口径疑问或 SQL 修正记录回流至数据治理团队，作为指标校准的输入。 | P2 |

---

## 4. 非功能需求 (Non-functional Requirements)

### 4.1 性能要求
*   **响应时间**：简单的 Text-to-SQL 生成与首字响应时间 < 3秒；复杂查询（含 RAG）首字响应 < 5秒。
*   **并发能力**：支持企业级并发访问，能够通过队列机制处理高峰期请求。

### 4.2 安全与隐私
*   **私有化部署**：支持 vLLM + 开源模型（Qwen 2.5-Coder 等）完全私有化部署，数据不出内网。
*   **数据脱敏**：对于敏感字段（如手机号、薪资）在展示层进行自动脱敏处理。

### 4.3 可靠性与兼容性
*   **数据库**：**PostgreSQL** 作为核心应用数据库，存储用户、权限、知识库等元数据。可扩展支持 Trino 连接外部数仓。
*   **浏览器兼容**：支持 Chrome, Edge, Safari 等主流现代浏览器。

---

## 5. 实施路线图 (Roadmap)

### 第一阶段：MVP —— 领域 Copilot (1-3个月)
*   **目标**：单一销售领域验证，SQL 准确率 > 80%。
*   **内容**：
    *   搭建基础架构 (Next.js + **FastAPI** + WrenAI + vLLM + **PostgreSQL**)。
    *   集成 WrenAI 原生建模与 SQL Pair 管理功能。
    *   实现核心 Chat 流程与**场景级权限控制**（暂不包含 RLS）。

### 第二阶段：产品化 —— 治理驱动自动化 (4-8个月)
*   **目标**：多领域自动接入，发布嵌入式 SDK。
*   **内容**：
    *   开发 Metadata Syncer，实现元数据自动化注入。
    *   封装 `<SmartQueryChat />` SDK，集成至 CRM/ERP。

### 第三阶段：成熟期 —— 自主智能 Agent (9-12个月+)
*   **目标**：主动分析与自我进化。
*   **内容**：
    *   实现 Self-Correction (SQL 自动修正)。
    *   开发主动异常预警 Agent。
    *   基于反馈数据进行 RLHF 微调。

---

## 6. 未来应用场景 (Future Scenarios)

1.  **经营决策驾驶舱**：高管实时问答，分钟级获取决策数据。
2.  **嵌入式业务助手**：CRM 中直接查询客户全生命周期数据。
3.  **智能归因与预警**：指标异动主动推送归因简报。
4.  **数据资产门户**：在资产目录中直接“对表提问”，所见即所问。
5.  **智能血缘与 Meta-QA**：查询数据本身的定义、来源与质量评分。
